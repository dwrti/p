name: Precise Video Compression (Target 199MB)

on:
  workflow_dispatch:

jobs:
  compress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download Video
        run: |
          # تأكد من وضع الرابط بين علامات تنصيص مفردة لتجنب مشاكل الرموز الخاصة
          curl -L 'https://abra--5e4bd524.api.cosmic-crab.buzz/f156c9e34b9b191a93ec53d5e1587ce27f3151ee/%D8%A3%D8%A3%D8%A8%D8%B7%D8%A7%D9%84%20%D8%A7%D9%84%D8%AF%D9%8A%D8%AC%D9%8A%D8%AA%D8%A7%D9%84%20%D8%B3%D8%A8%D9%8A%D8%B3%D8%AA%D9%88%D9%86%20265/04.mp4?api-key=8acbcf1e-732c-4574-a3bf-27e6a85b86f1&download=true&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NzAzMzA5NjIsInJhdGUiOiI1TSIsInJvbGUiOiJmcmVlIiwic2Vzc2lvbklEIjoiTVRjMk9UQTROREF6T1h4T2QzZEJUa1pLVTFaR1pGUlRWbWhGVGpCNFZsVnJZM2xTUlhSTFZWWm9VbE5zWkZwWFJFMTVVekZSZWxWRlpGaFVSbHBYVkd4d1JsUkZiRkJTYTJoR1ZGWmFWbFpWYUVkV01FVTlmT1I0QXRnWXJGOUV3NU93bHl4Uy13Nk8xY0lPZjlfR2VnbjI3SFI5by1YRyIsImRvbWFpbiI6IndlYnRvci5pbyIsImFnZW50IjoiTW96aWxsYS81LjAgKE1hY2ludG9zaDsgSW50ZWwgTWFjIE9TIFggMTBfMTVfNykgQXBwbGVXZWJLaXQvNjA1LjEuMTUgKEtIVE1MLCBsaWtlIEdlY2tvKSBWZXJzaW9uLzE2LjYuMSBTYWZhcmkvNjA1LjEuMTUiLCJyZW1vdGVBZGRyZXNzIjoiMjAwMToxNmE0OjI2ZDo0YjY0OmY0MTY6YTRkYzplMzo0MzFiIn0.b8QO7D4hxkmdHjo6IAQzL6KN9RM_u0yF_7DXR3YzXLE' -o input_video.mp4

      - name: Compress to Target Size (198MB)
        run: |
          # سنستهدف 198 ميجابايت لترك مساحة أمان بسيطة
          # Pass 1
          ffmpeg -y -i input_video.mp4 -c:v libx264 -b:v 1100k -pass 1 -an -f mp4 /dev/null
          # Pass 2 (مع الحفاظ على الصوت كما هو أو ضغطه قليلاً)
          ffmpeg -y -i input_video.mp4 -c:v libx264 -b:v 1100k -pass 2 -c:a aac -b:a 128k output_video.mp4

      - name: Upload to Catbox
        run: |
          RESPONSE=$(curl -F "reqtype=fileupload" -F "fileToUpload=@output_video.mp4" https://catbox.moe/user/api.php)
          echo "الرابط المباشر: $RESPONSE"
